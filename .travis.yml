language: python
os: linux
dist: xenial
sudo: true

install:
  - &upgrade_python_toolset pip install --upgrade pip setuptools wheel
  - &install_test_deps pip install --upgrade pytest pytest-sugar
  - &install_deps pip install -r CI_REQUIREMENTS.txt
  - pip install --upgrade pytest-cov coveralls

_python:
  - &python36
    name: "Python 3.6"
    python: "3.6"
  - &python37
    name: "Python 3.7"
    python: "3.7"

_helpers:
  - &install_cython pip install --upgrade Cython
  - &build_package python setup.py bdist_wheel
  - &install_built pip install advanced_descriptors --no-index -f dist
  - &test_no_cov  py.test -vv test
  - &test_cythonized
    stage: Test cythonized
    install:
      - *upgrade_python_toolset
      - *install_test_deps
      - *install_deps
      - *install_cython
    script:
      - *build_package
      - *install_built
      - *test_no_cov
    after_success: skip

  - &static_analysis
    stage: Static analysis
    <<: *python37
    after_success: skip

  - &code_style_check
    stage: Code style check
    <<: *python37
    after_success: skip

script:
  - python setup.py develop -v
  - py.test -vvv --cov-config .coveragerc --cov-report= --cov=advanced_descriptors test
  - coverage report -m --fail-under 89
after_success:
  - coveralls

jobs:
  include:
    - <<: *static_analysis
      name: "PyLint"
      install:
        - *upgrade_python_toolset
        - *install_deps
        - pip install --upgrade "pylint >= 2.3" isort[pyproject,requirements]
      script:
        - python setup.py --version
        - pylint advanced_descriptors
    - <<: *static_analysis
      name: "Bandit"
      install:
        - *upgrade_python_toolset
        - pip install --upgrade bandit
      script:
        - bandit -r advanced_descriptors
    - <<: *static_analysis
      name: "MyPy"
      install:
        - *upgrade_python_toolset
        - *install_deps
        - pip install --upgrade "mypy >= 0.700"
      script:
        - python setup.py --version
        - mypy --strict advanced_descriptors
    - <<: *static_analysis
      name: "PEP8"
      install:
        - *upgrade_python_toolset
        - pip install --upgrade flake8 flake8-bugbear
      script:
        - flake8

    #  - <<: *code_style_check
    #    name: "PEP257"
    #    install:
    #    - *upgrade_python_toolset
    #    - pip install --upgrade pydocstyle
    #    script:
    #    - pydocstyle advanced_descriptors
    - <<: *code_style_check
      name: "Black formatting"
      install:
        - *upgrade_python_toolset
        - pip install --upgrade black
      script:
        - black --check advanced_descriptors

    - stage: test
      <<: *python36
    - stage: test
      <<: *python37

    - <<: *test_cythonized
      <<: *python36
    - <<: *test_cythonized
      <<: *python37

    - stage: deploy
      # This prevents job from appearing in test plan unless commit is tagged:
      if: tag IS present
      # Run on pypy to build not cythonized wheel
      <<: *python37
      name: Build universal and cythonized bdist_wheel. Deploy bdist and sdist.
      services:
        - docker
      install:
        - *upgrade_python_toolset
        - *install_deps
      script:
        - ./tools/run_docker.sh "Advanced_Descriptors"
      before_deploy:
        - *build_package
      deploy:
        - provider: pypi
          # `skip_cleanup: true` is required to preserve binary wheels, built
          # inside of manylinux1 docker container during `script` step above.
          skip_cleanup: true
          user: penguinolog
          password:
            secure: "mG8p4UUzpz9wBdbif68NunjLp3rSED/OJw2Rh1nLBSSNcKtRBVEW4Gm/KYfHHc+kXVB66Nkda+T214kx4WhDk7lVRDKVu7ej0ze2mJX9iYmxhjOt7dcldostPAT8ZFfIvxEpS3UYGCPRbWTdOeeTe3wqz7/boVjC4DZu82nTarBJzApEn5ivtVHMs9bCedmk9Potb3FOiOscjkmEiKSllVQhgHnE/WPBOkfsaSaTCQKeTnqcCqJehNo4ki0cbmtAMpdPoR4DxAlHFK9jFD/W5Pm8s3UMkCer7vTwImINYICuibAIKEKcHdSHXOWJ6FoT21mJdgTWoZQGlAAKw8KV9R8dM6bNazV9iJbM3qUTUEJzyb08miRUf6iKxoPR1MpfqxuZ+ExGHfb0gX/Nu75aNxCSTbQ1YJD/oeXaqRQwpeGmW8vAXB9JSThfiEafymWMOKYuvgg0GPIP2RlLw7+zacfw9915VFiLpKSPrD48YU3p9jamIUeYb2aEDHpQK3rH4JUeAjdWV+a0mi0xWLjFzrVFc3R3jyUPAoxLNHLxzmb8+55pevA1JPUEYY2dolGBnZ7eXBAOIkHgEFlqqRxp4TLXoQR98eESYwrvaSV2YA11IuAJHF4bBI1pUfuUO7KiIDhacVi8VfNu5lAw8M1tInZk4aYLK6sw8L7XKq5hfZs="
          on:
            tags: true
            distributions: sdist
          skip_upload_docs: true
          skip_existing: true

cache: pip
before_cache:
  - rm -f $HOME/.cache/pip/log/debug.log
